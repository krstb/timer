<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robert’s Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Zusätzliche Stile für die App-Zentrierung */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f3f4f6; /* Hellgrau */
            padding: 1rem;
            color: #4b5563; /* Dunkle Textfarbe für den hellen Hintergrund */
        }
    </style>
</head>
<body>

    <div class="bg-white rounded-xl shadow-md w-full max-w-xs p-2 space-y-1 border-2 border-blue-500">
        <h1 class="text-lg font-bold text-center text-gray-800">
            Robert’s Timer
        </h1>
        
        <div class="space-y-1">
            <div class="flex space-x-2">
                <button id="set-time-button" class="flex-1 bg-blue-600 text-white font-bold py-1 px-3 rounded-lg shadow-sm hover:bg-blue-700 transition-colors duration-200 active:scale-95 text-sm">
                    Aktuelle Zeit setzen
                </button>
                <button id="toggle-display-button" class="flex-1 bg-gray-500 text-white font-bold py-1 px-3 rounded-lg shadow-sm hover:bg-gray-600 transition-colors duration-200 active:scale-95 text-sm">
                    Felder ein-/ausblenden
                </button>
            </div>

            <div class="bg-gray-50 border border-gray-200 p-2 rounded-lg text-center shadow-sm">
                <p class="text-gray-500 font-semibold text-xs">Startzeit:</p>
                <div class="relative flex items-center">
                    <input type="text" id="start-time-text" placeholder="TT.MM.JJJJ, HH:MM"
                           class="w-full p-2 border-2 border-gray-300 rounded-lg text-lg font-mono font-bold text-center focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-900 pr-10 transition-colors">
                    <button id="open-picker-button" class="absolute right-2 text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-calendar-alt"></i>
                    </button>
                    <input type="datetime-local" id="start-time-picker" class="hidden">
                </div>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 p-2 rounded-lg text-center shadow-sm">
                <p class="text-yellow-600 font-semibold text-xs">Pause (Minuten):</p>
                <input type="number" id="pause-time-input" placeholder="z.B. 30 oder -15"
                       class="w-full p-2 border-2 border-gray-300 rounded-lg text-lg font-mono font-bold text-center focus:outline-none focus:ring-2 focus:ring-yellow-500 bg-white text-gray-900">
            </div>
            
            <div id="display-fields-container" class="space-y-1 hidden">
                <div class="bg-green-50 border border-green-200 p-2 rounded-lg text-center shadow-sm">
                    <p class="text-green-600 font-semibold text-xs">Aktuelle Zeit (System):</p>
                    <p id="system-time-display" class="text-xl text-green-700 font-mono font-bold">--:--:--</p>
                </div>

                <div class="bg-blue-50 border border-blue-200 p-2 rounded-lg text-center shadow-sm">
                    <p id="elapsed-label" class="text-blue-600 font-semibold text-xs">Vergangene Zeit:</p>
                    <p id="elapsed-time-display" class="text-xl text-blue-700 font-mono font-bold">00:00:00</p>
                </div>

                <div class="space-y-1">
                    <h2 id="remaining-time-title" class="text-md font-bold text-center text-gray-700">Verbleibende Arbeitszeit</h2>
                    <div class="bg-red-50 border border-red-200 p-2 rounded-lg text-center shadow-sm">
                        <p class="text-red-600 font-semibold text-xs">Verbleibende Zeit:</p>
                        <p id="remaining-time-display" class="text-xl text-red-700 font-mono font-bold">00:00:00</p>
                    </div>
                </div>
            </div>
        </div>

        <hr class="border-t-2 border-gray-200 my-2" />
        
        <div class="space-y-1">
            <h2 class="text-md font-bold text-center text-gray-800">Endzeit</h2>
            <div class="bg-purple-800 border border-purple-600 p-2 rounded-lg text-center shadow-sm">
                <p class="text-white font-semibold text-xs">Endzeit:</p>
                <p id="end-time-display" class="text-xl text-white font-mono font-bold">--:--</p>
            </div>
        </div>
        
        <p class="text-[10px] text-center text-gray-400 mt-1">
            Der Zeitstempel wird lokal in Ihrem Browser gespeichert.
        </p>
    </div>
    
    <script>
        // --- DOM-Elemente abrufen ---
        const startTimeInputText = document.getElementById('start-time-text');
        const startTimeInputPicker = document.getElementById('start-time-picker');
        const openPickerButton = document.getElementById('open-picker-button');
        const elapsedTimeDisplay = document.getElementById('elapsed-time-display');
        const remainingTimeDisplay = document.getElementById('remaining-time-display');
        const remainingTimeContainer = remainingTimeDisplay.closest('.bg-red-50'); 
        const remainingTimeTitle = document.getElementById('remaining-time-title');
        const remainingTimeLabel = remainingTimeContainer.querySelector('p');
        const systemTimeDisplay = document.getElementById('system-time-display');
        const setTimeButton = document.getElementById('set-time-button');
        const toggleDisplayButton = document.getElementById('toggle-display-button');
        const displayFieldsContainer = document.getElementById('display-fields-container');
        const endTimeDisplay = document.getElementById('end-time-display');
        const elapsedLabel = document.getElementById('elapsed-label');
        const pauseTimeInput = document.getElementById('pause-time-input');

        // --- Globale Variablen für App-Daten ---
        let startTime = null;
        let pauseSeconds = 0;
        
        let totalWorkDurationSeconds; 
        let totalBreakSeconds;      
        let fullTimeReachedSeconds; 

        const berlinTimeZone = 'Europe/Berlin';
        const localStorageKey = 'roberts_zeitstempel_start_time';
        const localStoragePauseKey = 'roberts_zeitstempel_pause_time';
        
        let highTonePlayed = false;
        let lowTonePlayed = false;

        // ** Funktion zum dynamischen Einstellen der Arbeits- und Pausenzeiten **
        const updateWorkDurations = (date) => {
            let breakMinutes = 45; // Standard: 45 Minuten

            if (date) {
                const startHour = date.getHours();
                const startMinute = date.getMinutes();
                
                // ** KORRIGIERTE BEDINGUNG **
                // Bedingung: nach 9:30 Uhr (Stunde > 9 ODER (Stunde == 9 UND Minute > 30))
                if (startHour > 9 || (startHour === 9 && startMinute > 30)) {
                    breakMinutes = 30; // Ausnahme: 30 Minuten
                }
            }
            
            // Globale Variablen basierend auf der Pausenzeit setzen
            totalBreakSeconds = breakMinutes * 60; 
            totalWorkDurationSeconds = (8 * 60 + breakMinutes) * 60; 
            fullTimeReachedSeconds = (9 * 60 + breakMinutes) * 60; 
            
            // UI-Texte sofort aktualisieren
            remainingTimeTitle.textContent = `Verbleibende Arbeitszeit (8h ${breakMinutes}min)`;
            remainingTimeDisplay.textContent = formatTime(totalWorkDurationSeconds);
        };

        // --- Hilfsfunktion zum Parsen der manuellen Eingabe (TT.MM.JJJJ, HH:MM) ---
        const parseDateTimeString = (input) => {
            const parts = input.match(/^(\d{2})\.(\d{2})\.(\d{4}), (\d{2}):(\d{2})$/);
            if (!parts) {
                return null;
            }
            const [, day, month, year, hour, minute] = parts;
            const date = new Date(year, month - 1, day, hour, minute);
            if (date.getFullYear() != year || date.getMonth() != month - 1 || date.getDate() != day) {
                return null;
            }
            return date;
        };

        // --- Hilfsfunktion zum Formatieren der Zeit für die Eingabefelder (TT.MM.JJJJ, HH:MM) ---
        const formatForInput = (date) => {
            const pad = (num) => String(num).padStart(2, '0');
            const day = pad(date.getDate());
            const month = pad(date.getMonth() + 1);
            const year = date.getFullYear();
            const hour = pad(date.getHours());
            const minute = pad(date.getMinutes());
            return `${day}.${month}.${year}, ${hour}:${minute}`;
        };
        
        // --- Hilfsfunktion zur Anzeige von Datum und Uhrzeit (DD.MM.YYYY HH:MM) ---
        const formatDateTimeForDisplay = (date) => {
            if (!date) return '--:--';
            const formatter = new Intl.DateTimeFormat('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: berlinTimeZone
            });
            return formatter.format(date).replace(',', '');
        };

        // --- Funktion zum Aktualisieren der Endzeit ---
        const updateEndTimeDisplay = () => {
            if (startTime) {
                const endTime = new Date(startTime.getTime() + totalWorkDurationSeconds * 1000 + pauseSeconds * 1000);
                endTimeDisplay.textContent = formatDateTimeForDisplay(endTime);
            } else {
                endTimeDisplay.textContent = '--:--';
            }
        };

        // --- Daten aus dem lokalen Speicher laden und UI aktualisieren ---
        const loadData = () => {
            const storedTime = localStorage.getItem(localStorageKey);
            if (storedTime) {
                startTime = new Date(storedTime);
            } else {
                startTime = null;
            }

            updateWorkDurations(startTime); 
            
            startTimeInputText.value = startTime ? formatForInput(startTime) : '';
            startTimeInputPicker.value = startTime ? startTime.toISOString().slice(0, 16) : '';

            const storedPauseMinutes = localStorage.getItem(localStoragePauseKey);
            if (storedPauseMinutes) {
                pauseTimeInput.value = storedPauseMinutes;
                pauseSeconds = parseInt(storedPauseMinutes, 10) * 60;
            } else {
                pauseTimeInput.value = '';
                pauseSeconds = 0;
            }
            
            updateEndTimeDisplay();
        };
        
        // --- Funktion zum Leeren der Pausenzeit ---
        const clearPause = () => {
             pauseTimeInput.value = '';
             localStorage.removeItem(localStoragePauseKey);
             pauseSeconds = 0;
             updateEndTimeDisplay();
        };

        // --- Funktion zum Speichern von Daten im lokalen Speicher ---
        const saveData = (date) => {
            if (date && !isNaN(date.getTime())) {
                localStorage.setItem(localStorageKey, date.toISOString());
            } else {
                localStorage.removeItem(localStorageKey);
            }
            loadData(); 
            highTonePlayed = false;
            lowTonePlayed = false;
        };

        // --- Funktion zum Anzeigen eines temporären Erfolgs-Feedbacks ---
        const showSuccessFeedback = (button) => {
            const originalText = button.textContent;
            button.textContent = 'Erfolgreich! ✅';
            button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            button.classList.add('bg-green-600');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('bg-green-600');
                button.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 1000);
        };
        
        // **Tone-Generator-Funktionen**
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const masterGainNode = audioContext.createGain();
        masterGainNode.connect(audioContext.destination);
        masterGainNode.gain.value = 0.5;
        
        const lowGainNode = audioContext.createGain();
        const highGainNode = audioContext.createGain();
        lowGainNode.gain.value = 2.5; 
        highGainNode.gain.value = 1.0; 
        lowGainNode.connect(masterGainNode);
        highGainNode.connect(masterGainNode);

        function playTone(frequency = 440, isLowTone = false) {
            const oscillator = audioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            if (isLowTone) {
                oscillator.connect(lowGainNode);
            } else {
                oscillator.connect(highGainNode);
            }

            oscillator.start(0);
            oscillator.stop(audioContext.currentTime + 0.2); 
        }

        function playToneThrice(frequency, isLowTone = false) {
            playTone(frequency, isLowTone);
            setTimeout(() => playTone(frequency, isLowTone), 400);
            setTimeout(() => playTone(frequency, isLowTone), 800);
        }

        // --- Logik für die Echtzeit-Timer-Berechnung ---
        setInterval(() => {
            const now = Date.now();
            const now_date = new Date();
            const formatter = new Intl.DateTimeFormat('de-DE', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            systemTimeDisplay.textContent = formatter.format(now_date);
            
            const breakMinutes = totalBreakSeconds / 60;

            if (startTime) {
                const startMillis = startTime.getTime();
                const timeDifference = now - startMillis;
                
                if (timeDifference >= 0) {
                    elapsedLabel.textContent = "Vergangene Zeit:";
                    elapsedTimeDisplay.textContent = formatTime(Math.floor(timeDifference / 1000));
                } else {
                    elapsedLabel.textContent = "Zeit bis Start:";
                    elapsedTimeDisplay.textContent = formatTime(Math.abs(Math.floor(timeDifference / 1000)));
                }

                const elapsedSeconds = Math.max(0, Math.floor(timeDifference / 1000));
                const remainingSeconds = totalWorkDurationSeconds - (elapsedSeconds - pauseSeconds);
                
                if (remainingSeconds <= 0) {
                    remainingTimeContainer.classList.remove('bg-red-50', 'border-red-200');
                    remainingTimeContainer.classList.add('bg-green-50', 'border-green-200');
                    remainingTimeDisplay.classList.remove('text-red-700');
                    remainingTimeDisplay.classList.add('text-green-700');
                    remainingTimeLabel.classList.remove('text-green-600');
                    remainingTimeLabel.classList.add('text-green-600');

                    remainingTimeTitle.textContent = `Geleistete Arbeitszeit (8h ${breakMinutes}min)`;
                    remainingTimeLabel.textContent = "Erbrachte Arbeitszeit:";
                    
                    const actualWorkTimeSeconds = elapsedSeconds - totalBreakSeconds - pauseSeconds;
                    remainingTimeDisplay.textContent = formatTime(Math.max(0, actualWorkTimeSeconds));
                    
                    if (!highTonePlayed) {
                        playToneThrice(880, false);
                        highTonePlayed = true; 
                    }

                } else {
                    remainingTimeContainer.classList.remove('bg-green-50', 'border-green-200');
                    remainingTimeContainer.classList.add('bg-red-50', 'border-red-200');
                    remainingTimeDisplay.classList.remove('text-green-700');
                    remainingTimeDisplay.classList.add('text-red-700');
                    remainingTimeLabel.classList.remove('text-green-600');
                    remainingTimeLabel.classList.add('text-red-600');

                    remainingTimeTitle.textContent = `Verbleibende Arbeitszeit (8h ${breakMinutes}min)`;
                    remainingTimeLabel.textContent = "Verbleibende Zeit:";

                    remainingTimeDisplay.textContent = formatTime(remainingSeconds);
                    highTonePlayed = false;
                }
                
                const actualWorkTimeSeconds = elapsedSeconds - totalBreakSeconds - pauseSeconds;
                if (actualWorkTimeSeconds >= fullTimeReachedSeconds && !lowTonePlayed) {
                    playToneThrice(330, true);
                    lowTonePlayed = true; 
                } else if (actualWorkTimeSeconds < fullTimeReachedSeconds) {
                    lowTonePlayed = false;
                }
                
            } else {
                remainingTimeContainer.classList.remove('bg-green-50', 'border-green-200');
                remainingTimeContainer.classList.add('bg-red-50', 'border-red-200');
                remainingTimeDisplay.classList.remove('text-green-700');
                remainingTimeDisplay.classList.add('text-red-700');
                remainingTimeLabel.classList.remove('text-green-600');
                remainingTimeLabel.classList.add('text-red-600');
                
                remainingTimeTitle.textContent = `Verbleibende Arbeitszeit (8h ${breakMinutes}min)`;
                remainingTimeLabel.textContent = "Verbleibende Zeit:";
                
                elapsedLabel.textContent = "Vergangene Zeit:";
                elapsedTimeDisplay.textContent = '00:00:00';
                remainingTimeDisplay.textContent = formatTime(totalWorkDurationSeconds);
            }
        }, 1000);

        // --- Event-Listener für das "Aktuelle Zeit setzen" Knopf ---
        setTimeButton.addEventListener('click', () => {
            startTimeInputText.classList.remove('border-red-500', 'focus:ring-red-500');
            startTimeInputText.classList.add('border-gray-300', 'focus:ring-blue-500');

            saveData(new Date()); 
            clearPause();
            showSuccessFeedback(setTimeButton);
        });

        // --- Event-Listener für das manuelle Startzeit-Feld (mit Fehlerbehandlung) ---
        startTimeInputText.addEventListener('input', () => {
            const inputValue = startTimeInputText.value.trim();
            
            if (inputValue === '') {
                saveData(null); 
                clearPause();
                startTimeInputText.classList.remove('border-red-500', 'focus:ring-red-500');
                startTimeInputText.classList.add('border-gray-300', 'focus:ring-blue-500');
                return;
            }

            const manualDate = parseDateTimeString(inputValue);
            
            if (manualDate && !isNaN(manualDate.getTime())) {
                saveData(manualDate); 
                startTimeInputText.classList.remove('border-red-500', 'focus:ring-red-500');
                startTimeInputText.classList.add('border-gray-300', 'focus:ring-blue-500');
            } else {
                startTimeInputText.classList.add('border-red-500', 'focus:ring-red-500');
                startTimeInputText.classList.remove('border-gray-300', 'focus:ring-blue-500');
            }
        });

        // --- Event-Listener für den nativen Picker
        startTimeInputPicker.addEventListener('change', () => {
            const pickerDate = new Date(startTimeInputPicker.value);
            if (pickerDate && !isNaN(pickerDate.getTime())) {
                saveData(pickerDate); 
            }
        });
        
        // --- Öffnet den nativen Picker, wenn der Button oder das Feld geklickt wird
        openPickerButton.addEventListener('click', () => {
            startTimeInputPicker.showPicker();
        });
        
        // --- Event-Listener für das Pausen-Feld ---
        pauseTimeInput.addEventListener('input', () => {
             const minutes = parseInt(pauseTimeInput.value, 10);
             if (!isNaN(minutes)) {
                  pauseSeconds = minutes * 60;
                  localStorage.setItem(localStoragePauseKey, minutes);
             } else {
                  pauseSeconds = 0;
                  localStorage.removeItem(localStoragePauseKey);
             }
             updateEndTimeDisplay(); 
        });

        // --- Event-Listener für den neuen Ein-/Ausblenden-Button ---
        toggleDisplayButton.addEventListener('click', () => {
            displayFieldsContainer.classList.toggle('hidden');
        });

        // --- Hilfsfunktion zum Formatieren von Sekunden in HH:MM:SS ---
        const formatTime = (totalSeconds) => {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        };

        // --- App starten ---
        window.onload = loadData; 
    </script>
</body>
</html>
